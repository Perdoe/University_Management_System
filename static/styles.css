{% extends "base.html" %}
{% block content %}
<div class="container">
    <h1>Teacher Dashboard</h1>
    <h2>Welcome, {{ current_user.username }}</h2>

    <div class="action-buttons">
        <button class="action-button" onclick="setActiveView('schedule')">View Schedule</button>
        <button class="action-button" onclick="setActiveView('roster')">View Class Roster</button>
        <button class="action-button" onclick="setActiveView('grades')">Manage Grades</button>
    </div>

    <!-- Schedule View -->
    <div id="scheduleView" class="management-section view-section">
        <h2>Teaching Schedule</h2>
        <div>
            <table class="student-table">
                <thead>
                    <tr>
                        <th>Course</th>
                        <th>Semester</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in courses %}
                    <tr>
                        <td>{{ course.course_prefix }} {{ course.course_number }}</td>
                        <td>{{ course.semester }} {{ course.year_taught }}</td>
                        <td>Active</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Roster View -->
    <div id="rosterView" class="management-section view-section" style="display: none;">
        <h2>Class Rosters</h2>
        {% for course_name, students in course_rosters.items() %}
        <div class="student-section">
            <h3>{{ course_name }}</h3>
            <table class="student-table">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Grade</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>{{ student.student_id }}</td>
                        <td>{{ student.grade or 'N/A' }}</td>
                        <td>
                            <button onclick="updateGrade('{{ student.student_id }}', '{{ course_name }}')"
                                    class="action-button">
                                Update Grade
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>

    <a href="{{ url_for('signin') }}" class="back-button">Back to Sign In</a>
</div>

<script>
function setActiveView(view) {
    // Hide all views
    document.querySelectorAll('.view-section').forEach(el => {
        el.style.display = 'none';
    });

    // Show selected view
    if (view === 'schedule') {
        document.getElementById('scheduleView').style.display = 'block';
    } else if (view === 'roster' || view === 'grades') {
        document.getElementById('rosterView').style.display = 'block';
    }
}

async function updateGrade(studentId, courseName) {
    const newGrade = prompt('Enter new grade (A, B, C, D, or F):');
    if (!newGrade) return;

    const [prefix, number] = courseName.split(' ');

    try {
        const response = await fetch('/update_grade', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                student_id: studentId,
                course_prefix: prefix,
                course_number: number,
                grade: newGrade.toUpperCase()
            })
        });

        const result = await response.json();
        if (result.success) {
            alert('Grade updated successfully!');
            location.reload();
        } else {
            alert('Failed to update grade: ' + result.message);
        }
    } catch (error) {
        alert('Error updating grade: ' + error);
    }
}

// Show schedule view by default
setActiveView('schedule');
</script>
{% endblock %}